#include "..//inc//tm4c123gh6pm.h"
#include <stdint.h>
#include "PLL.h"
#include "Switch.h"
#include "NFC.h"
#include "Coin.h"
#include "LCD.h"

#define F16HZ (50000000/16)
#define F20KHZ (50000000/20000)

#define PF1       (*((volatile uint32_t *)0x40025008))
#define PF2       (*((volatile uint32_t *)0x40025010))
#define PF3       (*((volatile uint32_t *)0x40025020))
void DisableInterrupts(void); // Disable interrupts
void EnableInterrupts(void);  // Enable interrupts
long StartCritical (void);    // previous I bit, disable interrupts
void EndCritical(long sr);    // restore I bit to previous value
void WaitForInterrupt(void);  // low power mode

extern int8_t response[];
extern int size;

//commands for i2c
uint8_t killNFC[] = {0x52};
uint8_t selectNFC[] = {0x02, 0x00, 0xA4, 0x04, 0x00, 0x07, 0xD2, 0x76, 0x00, 0x00, 0x85, 0x01, 0x01, 0x00, 0x35, 0xC0};
//set GPO
uint8_t selectSystem[] = {0x03, 0x00, 0xA4, 0x00, 0x0C, 0x02, 0xE1, 0x01, 0xC0, 0x8C};
uint8_t readSystemLength[] = {0x02, 0x00, 0xB0, 0x00, 0x00, 0x02, 0x6B, 0x7D};
uint8_t readSystemContent[] = {0x03, 0x00, 0xB0, 0x00, 0x00, 0x12, 0xC1, 0x69};
uint8_t verifyPassword[] = {0x02, 0x00, 0x20, 0x00, 0x03, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x5E, 0x2B};
uint8_t setGPO[] = {0x03, 0x00, 0xD6, 0x00, 0x04, 0x01, 0x22, 0x4F, 0x93};
uint8_t setGPO2[] = {0x03, 0x00, 0xD6, 0x00, 0x04, 0x01, 0x11, 0x57, 0x90};
uint8_t selectSystem2[] = {0x02, 0x00, 0xA4, 0x00, 0x0C, 0x02, 0xE1, 0x01, 0x7F, 0x0D};
uint8_t readSystemLength2[] = {0x03, 0x00, 0xB0, 0x00, 0x00, 0x02, 0x40, 0x79};
uint8_t readSystemContent2[] = {0x02, 0x00, 0xB0, 0x00, 0x00, 0x12, 0xEA, 0x6D};

uint8_t selectCC[] = {0x03, 0x00, 0xA4, 0x00, 0x0C, 0x02, 0xE1, 0x03, 0xD2, 0xAF};
uint8_t selectNDEF[] = {0x03, 0x00, 0xA4, 0x00, 0x0C, 0x02, 0x00, 0x01, 0x81, 0x7C};
uint8_t clearNDEFFileLength[] = {0x02, 0x00, 0xD6, 0x00, 0x00, 0x02, 0x00, 0x00, 0xD4, 0xB6};
/*uint8_t message[] = {0x03, 0x00, 0xD6, 0x00, 0x02, 0x57, 0xD1, 0x01, 0x12, 0x54, 0x02, 0x65, 0x6E, 0x4E, 0x46, 0x43, 
	0x20, 0x44, 0x79, 0x6E, 0x61, 0x6D, 0x69, 0x63, 0x20, 0x54, 0x61, 0x67, 0x21, 0x33};*/
uint8_t message[] = {0x03, 0x00, 0xD6, 0x00, 0x02, 0x57, 0xD1, 0x02, 0x52, 0x53, 0x70, 0x91, 0x01, 0x0C, 0x55, 0x01, 0x73, 
		0x74, 0x2E, 0x63, 0x6F, 0x6D, 0x2F, 0x72, 0x66, 0x69, 0x64, 0x51, 0x01, 0x3E, 0x54, 0x02, 0x65, 0x6E, 0x4C, 0x65, 0x61, 
		0x72, 0x6E, 0x20, 0x74, 0x68, 0x65, 0x20, 0x6D, 0x61, 0x67, 0x69, 0x63, 0x20, 0x6F, 0x66, 0x20, 0x53, 0x54, 0x20, 0x4D, 
		0x69, 0x63, 0x72, 0x6F, 0x65, 0x6C, 0x65, 0x63, 0x74, 0x72, 0x6F, 0x6E, 0x69, 0x63, 0x73, 0x20, 0x44, 0x79, 0x6E, 0x61, 
		0x6D, 0x69, 0x63, 0x20, 0x54, 0x61, 0x67, 0x20, 0x50, 0x72, 0x6F, 0x64, 0x75, 0x63, 0x74, 0x73, 0xEF, 0x53};
//uint8_t fileLength[] = {0x03, 0x00, 0xD6, 0x00, 0x00, 0x02, 0x00, 0x16, 0xDC, 0x42};
uint8_t fileLength[] = {0x02, 0x00, 0xD6, 0x00, 0x00, 0x02, 0x00, 0x57, 0xEE, 0x90};
uint8_t readLength[] = {0x03, 0x00, 0xB0, 0x00, 0x00, 0x02, 0x40, 0x79};
//uint8_t readFile[] = {0x02, 0x00, 0xB0, 0x00, 0x02, 0x16, 0x7E, 0x18};
uint8_t readFile[] = {0x02, 0x00, 0xB0, 0x00, 0x02, 0x57, 0xF3, 0x4B};
uint8_t deselect[] = {0xC2, 0xE0, 0xB4};

int command_sizes[] = {1, 12, 10, 10, 10, 95, 10, 8, 8};

int sessionAmount = 0;
//state 0: begin transaction, state 1: transaction in progress, state 2: transaction finished
int currentState = 0;

void Button_Handler(int button){
	switch(button) {
	}
}

void Coin_Handler() {
	
}

int main(void){ 
  PLL_Init(Bus80MHz);              // bus clock at 50 MHz
	DisableInterrupts();
	
	SYSCTL_RCGCGPIO_R |= 0x20;            // activate port F
	
	GPIO_PORTF_DIR_R |= 0x06;             // make PF2, PF1 out (built-in LED)
  GPIO_PORTF_AFSEL_R &= ~0x06;          // disable alt funct on PF2, PF1
  GPIO_PORTF_DEN_R |= 0x06;             // enable digital I/O on PF2, PF1
                                        // configure PF2 as GPIO
  GPIO_PORTF_PCTL_R = (GPIO_PORTF_PCTL_R&0xFFFFF00F)+0x00000000;
  GPIO_PORTF_AMSEL_R = 0;               // disable analog functionality on PF
	
	Buttons_Init(Button_Handler);
	setupCoinSelector(Coin_Handler);
	setupNFCBoard();
	EnableInterrupts();
	
	GPIO_PORTF_DATA_R ^= 0x04;  
	
	/*readRequest(0xAC, 1, 0x52);
	readRequest(0xAC, 16, 0x02, 0x00, 0xA4, 0x04, 0x00, 0x07, 0xD2, 0x76, 0x00, 0x00, 0x85, 0x01, 0x01, 0x00, 0x35, 0xC0);
	readRequest(0xAC, 10, 0x03, 0x00, 0xA4, 0x00, 0x0C, 0x02, 0x00, 0x01, 0x81, 0x7C);
	readRequest(0xAC, 10, 0x02, 0x00, 0xD6, 0x00, 0x00, 0x02, 0x00, 0x00, 0xD4, 0xB6);
	readRequest(0xAC, 95, 0x03, 0x00, 0xD6, 0x00, 0x02, 0x57, 0xD1, 0x02, 0x52, 0x53, 0x70, 0x91, 0x01, 0x0C, 0x55, 0x01, 0x73, 
		0x74, 0x2E, 0x63, 0x6F, 0x6D, 0x2F, 0x72, 0x66, 0x69, 0x64, 0x51, 0x01, 0x3E, 0x54, 0x02, 0x65, 0x6E, 0x4C, 0x65, 0x61, 
		0x72, 0x6E, 0x20, 0x74, 0x68, 0x65, 0x20, 0x6D, 0x61, 0x67, 0x69, 0x63, 0x20, 0x6F, 0x66, 0x20, 0x53, 0x54, 0x20, 0x4D, 
		0x69, 0x63, 0x72, 0x6F, 0x65, 0x6C, 0x65, 0x63, 0x74, 0x72, 0x6F, 0x6E, 0x69, 0x63, 0x73, 0x20, 0x44, 0x79, 0x6E, 0x61, 
		0x6D, 0x69, 0x63, 0x20, 0x54, 0x61, 0x67, 0x20, 0x50, 0x72, 0x6F, 0x64, 0x75, 0x63, 0x74, 0x73, 0xEF, 0x53);
	readRequest(0xAC, 10, 0x02, 0x00, 0xD6, 0x00, 0x00, 0x02, 0x00, 0x57, 0xEE, 0x90);
	//readRequest(0xAC, 8, 0x03, 0x00, 0xB0, 0x00, 0x00, 0x02, 0x40, 0x79);
	//readRequest(0xAC, 8, 0x02, 0x00, 0xB0, 0x00, 0x02, 0x57, 0xF3, 0x4B);*/
	
	sendTransaction(killNFC, 1, 0, 0);
	sendTransaction(selectNFC, 16, 1, 5);
	/*sendTransaction(selectSystem, 10, 1, 5);
	sendTransaction(readSystemLength, 8, 1, 7);
	sendTransaction(readSystemContent, 8, 1, 23);
	sendTransaction(verifyPassword, 24, 1, 5);
	sendTransaction(setGPO2, 9, 1, 5);
	sendTransaction(selectSystem2, 10, 1, 5);
	sendTransaction(readSystemLength2, 8, 1, 7);
	sendTransaction(readSystemContent2, 8, 1, 23);*/
	//sendTransaction(selectCC, command_sizes[2], 1);
	sendTransaction(selectNDEF, 10, 1, 5);
	sendTransaction(clearNDEFFileLength, 10, 1, 5);
	sendTransaction(message, 95, 1, 5);
	sendTransaction(fileLength, 10, 1, 5);
	sendTransaction(readLength, 8, 1, 7);
	sendTransaction(readFile, 8, 1, 95);
	//sendTransaction(deselect, 3, 1);
	
	GPIO_PORTF_DATA_R ^= 0x04;  
	
/*	while(1) {
		//state 0
		//setup periodic timer to read tag
		//on receive connected message -> transition state (turn off NFC RF)
		//state 1
		//wait for input from Coin Selector -> update screen
		//wait for button press from Switch -> transition state (write to tag and turn on NFC RF)
		//state 2
		//on receive completed message -> transition state
	}*/

}
